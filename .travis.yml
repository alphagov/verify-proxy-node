language: java

env:
  global:
    - VERIFY_USE_PUBLIC_BINARIES=true
  # CODACY_PROJECT_TOKEN
    - secure: "lQ0rlJwFtLRbk8aAexwXLKZUp6LNuC9TGhHUsYD92WGTT03QDTGDbpbpQXStLEPthMzbrX1qPp+GmcTqRKHgSISP6LAXOeAuI6AZtuc0NKzLd/425JiaksytDv0m4rfuozRveUyZRMq/geqTRvtEuRiW6qDKRT8l0emtkT2olM584gTp2fJZw9k6TgTPebrj70N9Ec7T3DSYBqaFnNduHHRBVlbqmrnGF6tfMGQZ0rcOZFiMYpIuwaX9b5+rfTR5ZjbuWzyjK0MQdfH8stFGSiAYcwu3+Wfp7w416SnwQh/J2plFcA8I2pKZ9Gl63eQBGeGAyh+4fqYZz7XiqFkoaBCKOyHDHtPeqdbNZCU0fgzbfdCBjULUiI51ItF1SFDg21WxxS3gJBkh1wBMU14CvYpcQOwe5rKc1emdfuRndmTrpheOehXjdF3eYfQlqAnIeyzMlpYf3PzNWJojjSLy0be/Q97pA6S44+RVWVJEz57BiEV+Hxy9rp9S/JFR2TSCCHEF7g9flGeX6ImTcz274eKtRAIU2Tx9MqbBcDkY/CfevrO1usaV6qQ4uheZxhjxzj5WkZ/p21+r2GZNHffgQylYlIqiG4ZJHlFBU4fpdD+Tb6y/sPyjMJdgIxMU1q4YSu5nux21LQ3bmKp7WvcJx+NzfQmQ2E4QSW21LvYrOpA="
  # GITHUB_PAT
    - secure: "YiKkMfZP+Pj6R4wdecQN5G2JyyQC/BcRh9FUU69bLZtmcZo00QBPjOg/MK4/Ew0XUjjOmImSZ/e9ROVU9IEhUeDwZLo5OdqMha6ONVdGVd0cj+TNmaxAIHhw5wbL56vGbqwZUkxWyfLQfIWThBIEF14RcGnSFQLlURtBEfLe89WNRE93PLnRv/7ZDw+uH4V8t7RfjvDXXwBCE/WuDrpEerEw4cNrqWaJMWjY/exZyHcMPKJ9g3svvr/3GNjBRJ3TV/BO38mJM14S+N1Oi/+VzAc4+/wglqvqw3sq6L5K/UAuXtH7532ViLkHRowe5uRLKOj7b8VUcz3IdLBNYnJuYviBYS18rNH6yJF8dm2GkWe7gs4IOh4EYNlQST1cNd4tsz13TO8bdVVZmjZbOM4i5yDH9YCZzIklx8ZZJYKl8Bb/3Y9s6bk1rChEfKJQQXlTW2vDvBpaMQYzmaESClPYZpVFT+hHv7+lJIyP6KXBWSwcyfvAasUfr2tGkiQPIjmA7bA2kBD4uE44zvqAP0eCxI4Z6bH+s6BKxD8no+mtyqbJJpNC19mFncPgtaFMEQdruuSkwZy7aga0DteVvlxJyRzbJZPjnWit6DZ2v8YGCUiiTOY8LPmlqGDhbtTwF/De9wPrzb+3OOYJP4SLXuwPptAeSdd8Vxk2Ij/9bguB9tI="

jdk:
  - openjdk11

before_install:
  - sudo apt-get install jq
  - curl -u ida-codacy-bot:$GITHUB_PAT -LSs $(curl -u ida-codacy-bot:$GITHUB_PAT -LSs https://api.github.com/repos/codacy/codacy-coverage-reporter/releases/latest | jq -r '.assets | map({content_type, browser_download_url} | select(.content_type | contains("java-archive"))) | .[0].browser_download_url') -o codacy-coverage-reporter-assembly.jar

install:
  - npm install -g snyk@1.146.0

script:
  - ./gradlew --no-daemon test
  - snyk/test.sh
  - libs/check-dependencies.sh

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

after_success:
  - snyk/monitor.sh
  - ./gradlew jacocoRootReport
  - java -jar codacy-coverage-reporter-assembly.jar report -l Java -r build/reports/jacoco/jacocoRootReport/jacocoRootReport.xml

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
